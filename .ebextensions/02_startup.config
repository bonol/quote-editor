files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/01_migrate.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      cd /var/app/current
      source /var/app/venv/*/bin/activate
      
      echo "=== Environment Debug ==="
      echo "DATABASE_URL: $DATABASE_URL"
      echo "RAILS_ENV: $RAILS_ENV"
      echo "Current directory: $(pwd)"
      echo "========================"
      
      if [ -z "$DATABASE_URL" ]; then
        echo "ERROR: DATABASE_URL is not set!"
        exit 1
      fi
      
      echo "Running database migrations..."
      bin/rails db:migrate RAILS_ENV=production
      echo "Checking if database needs seeding..."
      bin/rails runner 'exit 0 if User.count > 0; load Rails.root.join("db/seeds.rb")' RAILS_ENV=production
      echo "Database setup complete"